
---
# Disable automatic sleep/suspend in Kali Linux VM using Caffeine
- name: Configure Kali VM for always-on panel display
  hosts: kali
  become: yes
  vars_files: 
    - ~/vaults/nullsec-ansible.yaml

  tasks:
    # Prevent system sleep at OS level
    - name: Mask systemd sleep targets
      systemd:
        name: "{{ item }}"
        masked: yes
      loop:
        - sleep.target
        - suspend.target
        - hibernate.target

    # Install Caffeine to prevent sleep/screensaver
    - name: Install Caffeine
      apt:
        name: caffeine
        state: present
        update_cache: yes

    # Remove screen lockers
    - name: Remove light-locker
      apt:
        name: light-locker
        state: absent

    # Auto-start Caffeine on login
    - name: Create autostart directory
      file:
        path: "/home/{{ ansible_facts.user_id }}/.config/autostart"
        state: directory
        owner: "{{ ansible_facts.user_id }}"
        mode: '0755'

    - name: Enable Caffeine autostart
      copy:
        dest: "/home/{{ ansible_facts.user_id }}/.config/autostart/caffeine.desktop"
        owner: "{{ ansible_facts.user_id }}"
        mode: '0644'
        content: |
          [Desktop Entry]
          Type=Application
          Name=Caffeine
          Exec=caffeine
          Hidden=false
          NoDisplay=false
          X-GNOME-Autostart-enabled=true

    - name: Start Caffeine system tray notifier
      command: caffeine-indicator
      become_user: "{{ ansible_facts.user_id }}"
      environment:
        DISPLAY: ":0"
        DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ ansible_facts.user_uid }}/bus"
      async: 10
      poll: 0
      ignore_errors: yes
